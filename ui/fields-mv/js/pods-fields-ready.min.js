var PodsUI = (function () {
  'use strict';

  var babelHelpers = {};
  babelHelpers.typeof = typeof Symbol === "function" && typeof Symbol.iterator === "symbol" ? function (obj) {
    return typeof obj;
  } : function (obj) {
    return obj && typeof Symbol === "function" && obj.constructor === Symbol ? "symbol" : typeof obj;
  };
  babelHelpers;

  var fileUploadLayout = "<div class=\"pods-ui-file-list\"></div>\n<div class=\"pods-ui-region\"></div>\n<div class=\"pods-ui-form\"></div>\n";

  /*global jQuery, _, Backbone, Mn */
  /**
   *
   */
  var FileUploadModel = Backbone.Model.extend({
  	defaults: {
  		'id': 0,
  		'icon': '',
  		'name': '',
  		'link': ''
  	}
  });

  /**
   *
   */
  var FileUploadCollection = Backbone.Collection.extend({
  	model: FileUploadModel
  });

  var fileUploadItem = "<input\n\tname=\"<%- attr.name %>[<%- id %>][id]\"\n\tdata-name-clean=\"<%- attr.name_clean %>-id\"\n\tid=\"<%- attr.id %>-<%- id %>-id\"\n\tclass=\"<%- attr.class %>\"\n\ttype=\"hidden\"\n\tvalue=\"<%- id %>\" />\n<ul class=\"pods-flex-meta media-item\">\n\t<% if ( 1 != options.file_limit ) { %>\n\t\t<li class=\"pods-flex-col pods-flex-handle\">Handle</li>\n\t<% } %>\n\t<li class=\"pods-flex-col pods-flex-icon\"><img class=\"pinkynail\" src=\"<%- icon %>\" alt=\"Icon\"></li>\n\t<li class=\"pods-flex-col pods-flex-name\">\n\t\t<% if ( 0 != options.file_edit_title ) { %>\n\t\t\t<input\n\t\t\t\tname=\"<%- attr.name %>[<%- id %>][title]\"\n\t\t\t\tdata-name-clean=\"<%- attr.name_clean %>-title\"\n\t\t\t\tid=\"pods-form-ui-<%- attr.name_clean %>-<%- id %>-title\"\n\t\t\t\tclass=\"pods-form-ui-field-type-text pods-form-ui-field-name-<%- attr.name_clean %>-title\"\n\t\t\t\ttype=\"text\"\n\t\t\t\tvalue=\"<%- name %>\"\n\t\t\t\ttabindex=\"2\"\n\t\t\t\tmaxlength=\"255\" />\n\t\t<% } else { %>\n\t\t\t<%- name %>\n\t\t<% } %>\n\t</li>\n\t<li class=\"pods-flex-col pods-flex-remove\"><a href=\"#remove\">Remove</a></li>\n\t<% if ( 0 != options.file_linked ) { %>\n\t\t<li class=\"pods-flex-col pods-flex-download\"><a href=\"<%- link %>\" target=\"_blank\">Download</a></li>\n\t<% } %>\n</ul>\n";

  /*global jQuery, _, Backbone, Mn */

  /**
   *
   */
  var PodsFieldListView = Mn.CollectionView.extend({
  	initialize: function initialize(options) {
  		this.fieldModel = options.fieldModel;
  		this.childViewOptions = { fieldModel: options.fieldModel };
  	}
  });

  /**
   *
   */
  var PodsFieldView = Mn.LayoutView.extend({
  	serializeData: function serializeData() {
  		var fieldModel = this.options.fieldModel;
  		var data = this.model ? this.model.toJSON() : {};

  		data.field_type = fieldModel.get('type');
  		data.attr = fieldModel.get('attributes');
  		data.options = fieldModel.get('options');

  		return data;
  	}
  });

  /**
   * Individual list items, representing a single file
   */
  var FileUploadItem = PodsFieldView.extend({
  	tagName: 'li',

  	className: 'pods-flex-item',

  	ui: {
  		dragHandle: '.pods-flex-handle',
  		downloadLink: '.pods-flex-download',
  		removeButton: '.pods-flex-remove'
  	},

  	template: _.template(fileUploadItem),

  	triggers: {
  		'click @ui.removeButton': 'remove:file:click'
  	}
  });

  /**
   * The file list container
   */
  var FileUploadList = PodsFieldListView.extend({
  	tagName: 'ul',

  	className: 'pods-flex-list',

  	childView: FileUploadItem,

  	onAttach: function onAttach() {
  		var fieldOptions = this.options.fieldModel.get('options');

  		// @todo
  		// http://stackoverflow.com/questions/1735372/jquery-sortable-list-scroll-bar-jumps-up-when-sorting/4187833#4187833

  		if (1 != fieldOptions['file_limit']) {
  			var sort_axis = 'y';

  			if ('tiles' == fieldOptions['file_field_template']) {
  				sort_axis = '';
  			}

  			// init sortable
  			this.$el.sortable({
  				containment: 'parent',
  				axis: sort_axis,
  				scrollSensitivity: 40,
  				tolerance: 'pointer',
  				opacity: 0.6
  			});
  		}
  	}
  });

  var fileUploadForm = "<a class=\"button pods-flex-add\" href=\"#\" tabindex=\"2\"><%= options.file_add_button %></a>";

  var FileUploadForm = PodsFieldView.extend({
  	tagName: 'div',

  	ui: {
  		addButton: '.pods-flex-add'
  	},

  	template: _.template(fileUploadForm),

  	triggers: {
  		'click @ui.addButton': 'add:file:click'
  	}
  });

  /*global jQuery, _, Backbone, Mn */
  /**
   *
   * @param {Object} options
   *
   * @param {Object} options.browseButton   Existing and attached DOM node
   * @param {Object} options.uiRegion       Marionette.Region object
   * @param {Object} options.fieldOptions
   *
   * @param {string} options.fieldOptions.file_modal_title
   * @param {string} options.fieldOptions.file_modal_add_button
   * @param {string} options.fieldOptions.file_limit
   * @param {string} options.fieldOptions.limit_extensions
   * @param {string} options.fieldOptions.limit_types
   * @param {string} options.fieldOptions.file_attachment_tab
   *
   * @param {Object} options.fieldOptions.plupload_init
   * @param {Object} options.fieldOptions.plupload_init.browse_button
   *
   * @class
   */
  var PodsFileUploader = Mn.Object.extend({

    constructor: function constructor(options) {
      // Magically set the object properties we need, they'll just "be there" for the concrete instance
      this.browseButton = options.browseButton;
      this.uiRegion = options.uiRegion;
      this.fieldOptions = options.fieldOptions;

      Mn.Object.call(this, options);
    }

  });

  var fileUploadQueue = "<ul class=\"pods-flex-meta media-item\">\n\t<% if ( '' === errorMsg ) { %>\n\t\t<li class=\"pods-flex-col pods-progress\"><div class=\"progress-bar\" style=\"width: <%- progress %>%;\"></div></li>\n\t<% } %>\n\t<li class=\"pods-flex-col pods-flex-name\"><%- filename %></li>\n</ul>\n<% if ( '' !== errorMsg ) { %>\n\t<div class=\"error\"><%- errorMsg %></div>\n<% } %>\n";

  var FileUploadQueueModel = Backbone.Model.extend({
  	defaults: {
  		id: 0,
  		filename: '',
  		progress: 0,
  		errorMsg: ''
  	}
  });

  /**
   *
   */
  var FileUploadQueueItem = Mn.LayoutView.extend({
  	model: FileUploadQueueModel,

  	tagName: 'li',

  	template: _.template(fileUploadQueue),

  	attributes: function attributes() {
  		return {
  			class: 'pods-flex-item',
  			id: this.model.get('id')
  		};
  	},

  	modelEvents: {
  		'change': 'onModelChanged'
  	},

  	onModelChanged: function onModelChanged() {
  		this.render();
  	}

  });

  /**
   *
   */
  var FileUploadQueue = Mn.CollectionView.extend({
  	tagName: 'ul',

  	className: 'pods-flex-list pods-flex-queue',

  	childView: FileUploadQueueItem
  });

var Queue = Object.freeze({
  	FileUploadQueueModel: FileUploadQueueModel,
  	FileUploadQueueItem: FileUploadQueueItem,
  	FileUploadQueue: FileUploadQueue
  });

  var Plupload = PodsFileUploader.extend({
  	plupload: {},

  	fileUploader: 'plupload',

  	initialize: function initialize() {
  		// Set the browse button argument for plupload... it's required
  		this.fieldOptions['plupload_init']['browse_button'] = this.browseButton;

  		this.plupload = new plupload.Uploader(this.fieldOptions['plupload_init']);
  		this.plupload.init();

  		// Setup all callbacks: ( event_name, callback, context )
  		this.plupload.bind('FilesAdded', this.onFilesAdded, this);
  		this.plupload.bind('UploadProgress', this.onUploadProgress, this);
  		this.plupload.bind('FileUploaded', this.onFileUploaded, this);
  	},

  	/**
    * Fired after files have been selected from the dialog
    *
    * @param up
    * @param files
    */
  	onFilesAdded: function onFilesAdded(up, files) {
  		var model = undefined,
  		    collection = undefined,
  		    view = undefined;

  		// Assemble the collection data for the file queue
  		collection = new Backbone.Collection();
  		jQuery.each(files, function (index, file) {
  			model = new FileUploadQueueModel({
  				id: file.id,
  				filename: file.name
  			});

  			collection.add(model);
  		});

  		// Create a new view based on the collection
  		view = new FileUploadQueue({ collection: collection });
  		view.render(); // Generate the HTML, not attached to the DOM yet

  		// Reset the region in case any error messages are hanging around from a previous upload
  		// and show the new file upload queue
  		this.uiRegion.reset();
  		this.uiRegion.show(view);

  		// Stash references
  		this.queueCollection = collection;

  		up.refresh();
  		up.start();
  	},

  	/**
    *
    * @param up
    * @param file
    */
  	onUploadProgress: function onUploadProgress(up, file) {
  		var model = this.queueCollection.get(file.id);
  		model.set({ progress: file.percent });
  	},

  	/**
    *
    * @param up
    * @param file
    * @param resp
    */
  	onFileUploaded: function onFileUploaded(up, file, resp) {
  		var model = this.queueCollection.get(file.id);
  		var response = resp.response;
  		var newFile = [];

  		// Error condition 1
  		if ("Error: " == resp.response.substr(0, 7)) {
  			response = response.substr(7);
  			if (window.console) {
  				console.log(response);
  			}

  			model.set({
  				progress: 0,
  				errorMsg: response
  			});
  		}
  		// Error condition 2
  		else if ("<e>" == resp.response.substr(0, 3)) {
  				response = jQuery(response).text(); // Strip tags, text only
  				if (window.console) {
  					console.log(response);
  				}

  				model.set({
  					progress: 0,
  					errorMsg: response
  				});
  			} else {
  				var json = response.match(/{.*}$/);

  				if (null !== json && 0 < json.length) {
  					json = jQuery.parseJSON(json[0]);
  				} else {
  					json = {};
  				}

  				if ('object' != (typeof json === 'undefined' ? 'undefined' : babelHelpers.typeof(json)) || jQuery.isEmptyObject(json)) {
  					if (window.console) {
  						console.log(response);
  					}
  					if (window.console) {
  						console.log(json);
  					}

  					model.set({
  						progress: 0,
  						errorMsg: 'There was an issue with the file upload, please try again.'
  					});
  					return;
  				}

  				newFile = {
  					id: json.ID,
  					icon: json.thumbnail,
  					name: json.post_title,
  					link: json.link
  				};

  				// Remove the file from the upload queue model and trigger an event for the hosting container
  				model.trigger('destroy', model);
  				this.trigger('added:files', newFile);
  			}
  	},

  	// This should never be called as plupload intercepts the button click event itself
  	invoke: function invoke() {
  		return;
  	}

  });

  var MediaModal = PodsFileUploader.extend({
  	mediaObject: {},

  	fileUploader: 'attachment',

  	invoke: function invoke() {

  		if (wp.Uploader.defaults.filters.mime_types === undefined) {
  			wp.Uploader.defaults.filters.mime_types = [{ title: 'Allowed Files', extensions: '*' }];
  		}

  		var defaultExt = wp.Uploader.defaults.filters.mime_types[0].extensions;

  		wp.Uploader.defaults.filters.mime_types[0].extensions = this.fieldOptions['limit_extensions'];

  		// set our settings
  		this.mediaObject = wp.media({
  			title: this.fieldOptions['file_modal_title'],
  			multiple: 1 != this.fieldOptions['file_limit'],
  			library: {
  				type: this.fieldOptions['limit_types']
  			},
  			// Customize the submit button.
  			button: {
  				// Set the text of the button.
  				text: this.fieldOptions['file_modal_add_button']
  			}
  		});

  		// One-shot callback ( event, callback, context )
  		this.mediaObject.once('select', this.onMediaSelect, this);

  		// open the frame
  		this.mediaObject.open();
  		this.mediaObject.content.mode(this.fieldOptions['file_attachment_tab']);

  		// Reset the allowed file extensions
  		wp.Uploader.defaults.filters.mime_types[0].extensions = defaultExt;
  	},

  	onMediaSelect: function onMediaSelect() {
  		var selection = this.mediaObject.state().get('selection');
  		var newFiles = [];

  		if (!selection) {
  			return;
  		}

  		// loop through the selected files
  		selection.each(function (attachment) {
  			var sizes = attachment.attributes.sizes;
  			var attachmentThumbnail = undefined;

  			// by default use the generic icon
  			attachmentThumbnail = attachment.attributes.icon;

  			// only thumbnails have sizes which is what we're on the hunt for
  			if (sizes !== undefined) {
  				// Get thumbnail if it exists
  				if (sizes.thumbnail !== undefined && sizes.thumbnail.url !== undefined) {
  					attachmentThumbnail = sizes.thumbnail.url;
  				} // If thumbnail doesn't exist, get full because this is a small image
  				else if (sizes.full !== undefined && sizes.full.url !== undefined) {
  						attachmentThumbnail = sizes.full.url;
  					}
  			}

  			newFiles.push({
  				id: attachment.attributes.id,
  				icon: attachmentThumbnail,
  				name: attachment.attributes.title,
  				link: attachment.attributes.url
  			});
  		});

  		// Fire an event with an array of models to be added
  		this.trigger('added:files', newFiles);
  	}

  });

  var Uploaders = [Plupload, MediaModal];

  var UNLIMITED_FILES = 0;

  var FileUpload = Mn.LayoutView.extend({
  	template: _.template(fileUploadLayout),

  	regions: {
  		list: '.pods-ui-file-list',
  		uiRegion: '.pods-ui-region', // "Utility" container for uploaders to use
  		form: '.pods-ui-form'
  	},

  	uploader: {},

  	onRender: function onRender() {
  		var listView = new FileUploadList({ collection: this.collection, fieldModel: this.model });
  		var formView = new FileUploadForm({ fieldModel: this.model });

  		this.showChildView('list', listView);
  		this.showChildView('form', formView);

  		// Setup the uploader and listen for a response event
  		this.uploader = this.createUploader();
  		this.listenTo(this.uploader, 'added:files', this.onAddedFiles);
  	},

  	/**
    * Fired by a remove:file:click trigger in any child view
    *
    * @param childView View that was the source of the event
    */
  	onChildviewRemoveFileClick: function onChildviewRemoveFileClick(childView) {
  		this.collection.remove(childView.model);
  	},

  	/**
    * Fired by a add:file:click trigger in any child view
    *
    * plupload fields should never generate this event as it places a shim over our button and handles the event
    * internally
    */
  	onChildviewAddFileClick: function onChildviewAddFileClick() {
  		// Invoke the uploader
  		this.uploader.invoke();
  	},

  	/**
    * Concrete uploader implementations simply need to: this.trigger( 'added:files', newFiles )
    *
    * @param {Object[]} data An array of model objects to be added
    */
  	onAddedFiles: function onAddedFiles(data) {
  		var options = this.model.get('options');
  		var fileLimit = +options['file_limit']; // Unary plus to force to number
  		var newCollection = undefined,
  		    filteredModels = undefined;

  		// Get a copy of the existing collection with the new files added
  		newCollection = this.collection.clone();
  		newCollection.add(data);

  		// Enforce the file limit option if one is set
  		if (UNLIMITED_FILES === fileLimit) {
  			filteredModels = newCollection.models;
  		} else {
  			// Number of uploads is limited: keep the last N models, FIFO/queue style
  			filteredModels = newCollection.filter(function (model) {
  				return newCollection.indexOf(model) >= newCollection.length - fileLimit;
  			});
  		}

  		this.collection.reset(filteredModels);
  	},

  	createUploader: function createUploader() {
  		var options = this.model.get('options');
  		var targetUploader = options['file_uploader'];
  		var Uploader = undefined;

  		jQuery.each(Uploaders, function (index, thisUploader) {
  			if (targetUploader === thisUploader.prototype.fileUploader) {
  				Uploader = thisUploader;
  				return false;
  			}
  		});

  		if (Uploader !== undefined) {
  			this.uploader = new Uploader({
  				// We provide regular DOM element for the button
  				browseButton: this.getRegion('form').getEl('.pods-flex-add').get(),
  				uiRegion: this.getRegion('uiRegion'),
  				fieldOptions: options
  			});
  			return this.uploader;
  		} else {
  			throw "Could not locate file uploader '" + targetUploader + "'";
  		}
  	}
  });

  var pickLayout = "<div class=\"view-selector\"></div>\n<div class=\"pods-pick-values\"></div>\n<div class=\"pods-ui-add-new\"></div>";

  /*global jQuery, _, Backbone, Mn, wp */

  /**
   * A frame for displaying a modal popup with iframe content
   *
   * @augments wp.media.view.Frame
   */
  var IframeFrame = wp.media.view.Frame.extend({
  	className: 'pods-modal-frame',

  	template: _.template('<div class="media-frame-title" /><div class="media-frame-iframe" />'),

  	regions: ['title', 'iframe'],

  	initialize: function initialize() {
  		wp.media.view.Frame.prototype.initialize.apply(this, arguments);

  		// Ensure core UI is enabled.
  		this.$el.addClass('wp-core-ui');

  		this.initState();
  		this.initModal();

  		this.on('iframe:create:default', this.iframeContent, this);
  		this.iframe.mode('default');

  		this.on('title:create:default', this.createTitle, this);
  		this.title.mode('default');
  		this.on('title:render', function (view) {
  			view.$el.append('<span class="dashicons dashicons-arrow-down"></span>');
  		});
  	},

  	initState: function initState() {
  		var title = this.options.title || 'Add New Record';
  		var src = this.options.src || '/';

  		this.states.add([new wp.media.controller.State({
  			id: 'default',
  			title: title,
  			src: src
  		})]);

  		this.options.state = 'default';
  	},

  	initModal: function initModal() {
  		this.modal = new wp.media.view.Modal({
  			controller: this
  		});

  		this.modal.content(this);
  	},

  	render: function render() {
  		// Activate the default state if no active state exists.
  		if (!this.state() && this.options.state) {
  			this.setState(this.options.state);
  		}
  		/**
     * call 'render' directly on the parent class
     */
  		return wp.media.view.Frame.prototype.render.apply(this, arguments);
  	},

  	/**
    * @param {Object} content
    * @this wp.media.controller.Region
    */
  	iframeContent: function iframeContent(content) {
  		content.view = new wp.media.view.Iframe({
  			controller: this
  		});
  	},

  	createTitle: function createTitle(title) {
  		title.view = new wp.media.View({
  			controller: this,
  			tagName: 'h1'
  		});
  	}
  });

  var viewSelectorTemplate = "<span class=\"checkbox\" style=\"background-color: #c7def8; display: inline-block; padding: 5px 10px; margin: 10px 0; border-radius: 4px; cursor: pointer;\">\n\tCheckbox\n</span>\n<span class=\"select\" style=\"background-color: #c7def8; display: inline-block; padding: 5px 10px; margin: 10px 0; border-radius: 4px; cursor: pointer;\">\n\tSelect\n</span>\n<span class=\"flex\" style=\"background-color: #c7def8; display: inline-block; padding: 5px 10px; margin: 10px 0; border-radius: 4px; cursor: pointer;\">\n\tFlex\n</span>";

  var PickViewSelector = Mn.LayoutView.extend({
  	template: _.template(viewSelectorTemplate),

  	ui: {
  		checkbox: '.checkbox',
  		select: '.select',
  		flex: '.flex'
  	},

  	triggers: {
  		'click @ui.checkbox': 'checkbox:view:click',
  		'click @ui.select': 'select:view:click',
  		'click @ui.flex': 'flex:view:click'
  	}
  });

  var checkboxItem = "<div class=\"pods-field pods-boolean\">\n\t<input\n\t\tname=\"<%- attr.name %>[<%= ordinal %>]\"\n\t\t<%= selected ? 'checked=\"checked\"' : '' %>\n\t\tdata-name-clean=\"<%- attr.name_clean %>\"\n\t\tdata-label=\"<%- options.label %>\"\n\t\tid=\"<%- attr.id %><%= ordinal %>\"\n\t\tclass=\"pods-form-ui-field-type-pick\"\n\t\ttype=\"checkbox\" tabindex=\"2\" value=\"<%- id %>\">\n\t<label class=\"pods-form-ui-label\" for=\"<%- attr.id %><%= ordinal %>\">\n\t\t<%= name %>\n\t</label>\n</div>\n";

  /**
   *
   */
  var CheckboxItem = PodsFieldView.extend({
  	tagName: 'li',

  	template: _.template(checkboxItem),

  	className: 'pods-pick',

  	ui: {
  		checkbox: 'input.pods-form-ui-field-type-pick'
  	},

  	triggers: {
  		'click @ui.checkbox': 'toggle:selected'
  	},

  	modelEvents: {
  		'change': 'modelChanged'
  	},

  	templateHelpers: function templateHelpers() {
  		return {
  			ordinal: this.model.collection.indexOf(this.model)
  		};
  	},

  	modelChanged: function modelChanged() {
  		this.render();
  	},

  	onToggleSelected: function onToggleSelected() {
  		this.model.toggleSelected();
  	}
  });

  /**
   *
   */
  var CheckboxView = PodsFieldListView.extend({
  	tagName: 'ul',

  	className: 'pods-checkbox-view',

  	childView: CheckboxItem
  });

  /**
   *
   */
  var SelectItem = PodsFieldView.extend({
  	tagName: 'option',

  	template: false,

  	initialize: function initialize() {
  		this.$el.val(this.model.get('id'));

  		this.$el.html(this.model.get('name'));

  		if (this.model.get('selected')) {
  			this.$el.prop('selected', 'selected');
  		}
  	}
  });

  /**
   *
   */
  var SelectView = PodsFieldListView.extend({
  	tagName: 'select',

  	childView: SelectItem,

  	triggers: {
  		'change': 'change:selected'
  	},

  	attributes: function attributes() {
  		var fieldModel = this.options.fieldModel;
  		var fieldAttributes = fieldModel.get('attributes');
  		var fieldOptions = fieldModel.get('options');

  		return {
  			'name': fieldAttributes.name + '[]',
  			'class': fieldAttributes.class,
  			'data-name-clean': fieldAttributes['name_clean'],
  			'id': fieldAttributes.id,
  			'tabindex': '2',
  			'multiple': fieldOptions['pick_format_type']
  		};
  	},

  	onChangeSelected: function onChangeSelected() {
  		this.collection.setSelected(this.$el.val());
  	}
  });

  var flexItem = "<input name=\"pods_meta_file_test[<%- attr.id %>][attr.id]\"\n\t\tdata-name-clean=\"pods-meta-file-test-id-id\"\n\t\tid=\"pods-form-ui-pods-meta-file-test-id-id\"\n\t\tclass=\"pods-form-ui-field-type-text pods-form-ui-field-name-pods-meta-file-test-id-id\"\n\t\ttype=\"hidden\"\n\t\tvalue=\"<%- attr.id %>>\">\n<ul class=\"pods-flex-meta relationship-item\">\n\t<li class=\"pods-flex-col pods-flex-handle\">Handle</li>\n\t<% if ( icon != '' ) { %>\n\t\t<li class=\"pods-flex-col pods-flex-icon\">\n\t\t\t<img class=\"pinkynail\" src=\"<%- icon %>\" alt=\"Icon\">\n\t\t</li>\n\t<% } %>\n\t<li class=\"pods-flex-col pods-flex-name\">\n\t\t<input name=\"pods_meta_file_test[<%- attr.id %>][title]\"\n\t\t\t\tdata-name-clean=\"pods-meta-file-test-id-title\"\n\t\t\t\tid=\"pods-form-ui-pods-meta-file-test-id-title\"\n\t\t\t\tclass=\"pods-form-ui-field-type-text pods-form-ui-field-name-pods-meta-file-test-id-title\"\n\t\t\t\ttype=\"text\"\n\t\t\t\tvalue=\"<%= name %>\"\n\t\t\t\ttabindex=\"2\"\n\t\t\t\tmaxlength=\"255\">\n\t</li>\n\t<li class=\"pods-flex-col pods-flex-remove\">\n\t\t<a href=\"#remove\">Remove</a>\n\t</li>\n</ul>\n";

  /**
   *
   */
  var FlexItem = PodsFieldView.extend({
  	tagName: 'li',

  	className: 'pods-flex-item pods-relationship',

  	template: _.template(flexItem),

  	events: {
  		'click .pods-flex-remove a': 'delete_item_click'
  	},

  	delete_item_click: function delete_item_click(e) {
  		e.preventDefault();

  		// "delete" really just toggles selected to false for relationships
  		this.model.toggle_selected();
  	}
  });

  /**
   *  Represents the markup of the container as a whole
   */
  var FlexView = PodsFieldListView.extend({ // Cache the template function for the overall container
  	tagName: 'ul',

  	className: 'pods-flex-list pods-relationship',

  	childView: FlexItem

  	/*
   events: {
   	'click .button.pods-flex-relationship-add': 'add_new_click'
   }
   */

  	/*
   render: function () {
   	var $el, filtered_collection;
   		// Rebuild the entire view from scratch, starting with the container template
   	$el = this.$el;
   	$el.empty();
   	$el.html( this.template() );
   		// We only want to display selected items, our specialized collection has a helper method to give us a
   	// new collection with just that
   	filtered_collection = this.collection.filter_selected();
   		// Add an item view to the HTML list for each one in our filtered collection
   	filtered_collection.each( function ( item_model ) {
   		var view = new app.flex_item_view( { model: item_model } );
   		$el.find( 'ul.pods-collection-container' ).append( view.render().el );
   	} );
   		// Chaining
   	return this;
   },
   */

  	/*
   add_new_click: function ( e ) {
   	e.preventDefault();
   	var item_model = app.get_spoof_data.create_spoof_item();
   	this.collection.add( item_model ); // add item to collection; view is updated via event 'add'
   }
   */
  });

  var addNew = "<a href=\"/wp-admin/?pods_modal=1\"\n\t\tclass=\"button pods-related-add-new pods-modal\"\n\t\tdata-pod-id=\"<%- options.pod_id %>\"\n\t\tdata-field-id=\"<%- options.id %>\"\n\t\tdata-item-id=\"<%- options.item_id %>\">\n\tAdd New\n</a>";

  var AddNew = PodsFieldView.extend({
  	tagName: 'div',

  	className: 'podsform-flex-relationship-container',

  	ui: {
  		addButton: '.pods-related-add-new'
  	},

  	template: _.template(addNew),

  	triggers: {
  		'click @ui.addButton': 'add:new:click'
  	}
  });

  /**
   *
   */
  var Pick = Mn.LayoutView.extend({
  	template: _.template(pickLayout),

  	regions: {
  		viewSelector: '.view-selector',
  		list: '.pods-pick-values',
  		addNew: '.pods-ui-add-new'
  	},

  	onRender: function onRender() {
  		var list = new CheckboxView({ collection: this.collection, fieldModel: this.model });
  		var addNew = new AddNew({ fieldModel: this.model });

  		this.showChildView('viewSelector', new PickViewSelector({}));
  		this.showChildView('list', list);
  		this.showChildView('addNew', addNew);
  	},

  	onChildviewAddNewClick: function onChildviewAddNewClick(childView) {
  		var options = this.model.get('options');

  		var modalFrame = new IframeFrame({
  			title: 'The Title',
  			src: options['iframe_src']
  		});
  		modalFrame.modal.open();
  	},

  	addNewSuccess: function addNewSuccess(response) {
  		console.log(response);
  	},

  	/**
    * Fun for testing
    */
  	onChildviewCheckboxViewClick: function onChildviewCheckboxViewClick(childView) {
  		var view = new CheckboxView({ collection: this.collection, fieldModel: this.model });
  		this.showChildView('list', view);
  	},

  	onChildviewSelectViewClick: function onChildviewSelectViewClick(childView) {
  		var view = new SelectView({ collection: this.collection, fieldModel: this.model });
  		this.showChildView('list', view);
  	},

  	onChildviewFlexViewClick: function onChildviewFlexViewClick(childView) {
  		var view = new FlexView({ collection: this.collection, fieldModel: this.model });
  		this.showChildView('list', view);
  	}

  });



  var fieldClasses = Object.freeze({
  	FileUpload: FileUpload,
  	Pick: Pick
  });

  /*global jQuery, _, Backbone, Mn */
  var PodsFieldModel = Backbone.Model.extend({
  	defaults: {
  		type: 'hidden',
  		attributes: {},
  		options: {}
  	}
  });

  /*global jQuery, _, Backbone, Mn */

  /**
   *
   */
  var RelationshipModel = Backbone.Model.extend({
  	defaults: {
  		'id': 0,
  		'name': '',
  		'icon': '',
  		'selected': false
  	},

  	toggleSelected: function toggleSelected() {
  		this.set('selected', !this.get('selected'));
  	}
  });

  /**
   *
   */
  var RelationshipCollection = Backbone.Collection.extend({
  	model: RelationshipModel,

  	/**
    *
    * @param { ?string[] } ids
    */
  	setSelected: function setSelected(ids) {
  		this.map(function (thisModel) {
  			var selected = _.contains(ids, thisModel.get('id') + '');
  			thisModel.set('selected', selected);
  		});
  	},

  	/**
    * Return a new collection containing just the selected items in this one
    *
    * @returns {*}
    */
  	filterSelected: function filterSelected() {

  		// Get an array with only the selected items
  		var filtered = this.filter(function (itemModel) {
  			return itemModel.get('selected');
  		});

  		// this.filter is going to return an array, so create a collection out of it
  		return new RelationshipCollection(filtered);
  	}
  });

  /**
   * @param {string} fieldType
   */
  var fieldFactory = function fieldFactory(fieldType) {
  	var field = {};

  	switch (fieldType) {
  		case 'file-upload':
  			field.control = FileUpload;
  			field.collection = FileUploadCollection;
  			break;

  		case 'pick':
  			field.control = Pick;
  			field.collection = RelationshipCollection;
  			break;
  	}

  	return field;
  };

  /**
   * Custom jQuery plugin to handle Pods Fields
   *
   * @param {Object} fields Object to which new fields will be added, in { fieldId: fieldInstance } format
   */
  var podsFieldsInit = function podsFieldsInit(fields) {

  	return this.each(function () {
  		var data = {},
  		    fieldModel = undefined,
  		    fieldId = undefined,
  		    fieldControl = undefined,
  		    field = undefined;

  		// Combine data from all in-line data scripts in the container
  		jQuery(this).find('script.pods-form-field-data').each(function () {
  			var thisData = jQuery.parseJSON(jQuery(this).html());
  			jQuery.extend(data, thisData);
  			jQuery(this).remove();
  		});

  		// Ignore anything that doesn't have the field type set
  		if (data['field_type'] !== undefined) {

  			fieldControl = fieldFactory(data['field_type']);
  			if (fieldControl.control !== undefined) {
  				fieldModel = new PodsFieldModel({
  					type: data['field_type'],
  					attributes: data['field_meta']['field_attributes'],
  					options: data['field_meta']['field_options']
  				});

  				fieldId = data['field_meta']['field_attributes'].id;

  				field = new fieldControl.control({
  					el: this,
  					model: fieldModel,
  					collection: new fieldControl.collection(data['model_data'])
  				});
  				field.render();
  				fields[fieldId] = field;
  			}
  		}
  	});
  };

  // @todo: just here for testing the file upload queue

  var PodsUI = {
  	fieldClasses: fieldClasses,
  	fields: {},
  	Queue: Queue
  };
  /**
   * This is the workhorse that currently kicks everything off
   */
  jQuery.fn.podsFieldsInit = podsFieldsInit;
  jQuery(function () {
  	jQuery('.pods-form-ui-field').podsFieldsInit(PodsUI.fields);
  });

  return PodsUI;

}());