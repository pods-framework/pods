var PodsDFV = (function () {
  'use strict';

  var babelHelpers = {};
  babelHelpers.typeof = typeof Symbol === "function" && typeof Symbol.iterator === "symbol" ? function (obj) {
    return typeof obj;
  } : function (obj) {
    return obj && typeof Symbol === "function" && obj.constructor === Symbol ? "symbol" : typeof obj;
  };
  babelHelpers;

  /*global jQuery, _, Backbone, Marionette */
  var PodsDFVFieldModel = Backbone.Model.extend({
  	defaults: {
  		htmlAttr: {},
  		fieldConfig: {}
  	}
  });

  /**
   *
   */
  var PodsFieldListView = Marionette.CollectionView.extend({
  	initialize: function initialize(options) {
  		this.fieldModel = options.fieldModel;
  		this.childViewOptions = { fieldModel: options.fieldModel };
  	}
  });

  /**
   * @extends Backbone.View
   */
  var PodsFieldView = Marionette.View.extend({
  	serializeData: function serializeData() {
  		var fieldModel = this.options.fieldModel;
  		var data = this.model ? this.model.toJSON() : {};

  		data.htmlAttr = fieldModel.get('htmlAttr');
  		data.fieldConfig = fieldModel.get('fieldConfig');

  		return data;
  	}
  });

  /**
   * Top-level "main field container"
   */
  var PodsDFVFieldLayout = Marionette.View.extend({

  	initialize: function initialize(options) {
  		this.fieldItemData = options.fieldItemData;
  	}
  });

  /*global jQuery, _, Backbone, Marionette */
  /**
   *
   */
  var FileUploadModel = Backbone.Model.extend({
  	defaults: {
  		'id': 0,
  		'icon': '',
  		'name': '',
  		'edit_link': '',
  		'link': '',
  		'download': ''
  	}
  });

  /**
   *
   */
  var FileUploadCollection = Backbone.Collection.extend({
  	model: FileUploadModel
  });

  /*global jQuery, _, Backbone, Marionette, wp */
  var template$1 = '<input\n\tname="<%- htmlAttr.name %>[<%- id %>][id]"\n\tdata-name-clean="<%- htmlAttr.name_clean %>-id"\n\tid="<%- htmlAttr.id %>-<%- id %>-id"\n\tclass="<%- htmlAttr.class %>"\n\ttype="hidden"\n\tvalue="<%- id %>" />\n<ul class="pods-dfv-list-meta media-item">\n\t<% if ( 1 != fieldConfig.file_limit ) { %>\n\t\t<li class="pods-dfv-list-col pods-dfv-list-handle"><span>Reorder</span></li>\n\t<% } %>\n\t<li class="pods-dfv-list-col pods-dfv-list-icon"><img class="pinkynail" src="<%- icon %>" alt="Icon"></li>\n\t<li class="pods-dfv-list-col pods-dfv-list-name">\n\t\t<% if ( 0 != fieldConfig.file_edit_title ) { %>\n\t\t\t<input\n\t\t\t\tname="<%- htmlAttr.name %>[<%- id %>][title]"\n\t\t\t\tdata-name-clean="<%- htmlAttr.name_clean %>-title"\n\t\t\t\tid="pods-form-ui-<%- htmlAttr.name_clean %>-<%- id %>-title"\n\t\t\t\tclass="pods-form-ui-field-type-text pods-form-ui-field-name-<%- htmlAttr.name_clean %>-title"\n\t\t\t\ttype="text"\n\t\t\t\tvalue="<%- name %>"\n\t\t\t\ttabindex="2"\n\t\t\t\tmaxlength="255" />\n\t\t<% } else { %>\n\t\t\t<%- name %>\n\t\t<% } %>\n\t</li>\n\t<li class="pods-dfv-list-col pods-dfv-list-actions">\n\t\t<ul>\n\t\t\t<li class="pods-dfv-list-col pods-dfv-list-remove"><a href="#remove">Remove</a></li>\n\t\t\t<% if ( 1 == fieldConfig.file_linked && \'\' != download ) { %>\n\t\t\t\t<li class="pods-dfv-list-col pods-dfv-list-download"><a href="<%- download %>" target="_blank">Download</a></li>\n\t\t\t<% } %>\n\t\t\t<% if ( 1 == fieldConfig.file_show_view_link && \'\' != link ) { %>\n\t\t\t\t<li class="pods-dfv-list-col pods-dfv-list-link"><a href="<%- link %>" target="_blank">View</a></li>\n\t\t\t<% } %>\n\t\t\t<% if ( 1 == fieldConfig.file_show_edit_link && \'\' != edit_link ) { %>\n\t\t\t\t<li class="pods-dfv-list-col pods-dfv-list-edit"><a href="<%- edit_link %>" target="_blank">Edit</a></li>\n\t\t\t<% } %>\n\t\t</ul>\n\t</li>\n</ul>\n';


  /**
   * Individual list items, representing a single file
   */
  var FileUploadItem = PodsFieldView.extend({
  	tagName: 'li',

  	className: 'pods-dfv-list-item',

  	ui: {
  		dragHandle: '.pods-dfv-list-handle',
  		editLink: '.pods-dfv-list-edit-link',
  		viewLink: '.pods-dfv-list-link',
  		downloadLink: '.pods-dfv-list-download',
  		removeButton: '.pods-dfv-list-remove',
  		itemName: '.pods-dfv-list-name'
  	},

  	template: _.template(template$1),

  	triggers: {
  		'click @ui.removeButton': 'remove:file:click'
  	}
  });

  /**
   * The file list container
   */
  var FileUploadList = PodsFieldListView.extend({
  	tagName: 'ul',

  	className: 'pods-dfv-list',

  	childView: FileUploadItem,

  	onAttach: function onAttach() {
  		var fieldConfig = this.options.fieldModel.get('fieldConfig');

  		// @todo
  		// http://stackoverflow.com/questions/1735372/jquery-sortable-list-scroll-bar-jumps-up-when-sorting/4187833#4187833

  		if (1 != fieldConfig['file_limit']) {
  			var sort_axis = 'y';

  			if ('tiles' == fieldConfig['file_field_template']) {
  				sort_axis = '';
  			}

  			// init sortable
  			this.$el.sortable({
  				containment: 'parent',
  				axis: sort_axis,
  				scrollSensitivity: 40,
  				tolerance: 'pointer',
  				opacity: 0.6
  			});
  		}
  	}
  });

  /*global jQuery, _, Backbone, Marionette, wp */
  var template$2 = '<a class="button pods-dfv-list-add" href="#" tabindex="2"><%= fieldConfig.file_add_button %></a>';


  var FileUploadForm = PodsFieldView.extend({
  	tagName: 'div',

  	ui: {
  		addButton: '.pods-dfv-list-add'
  	},

  	template: _.template(template$2),

  	triggers: {
  		'click @ui.addButton': 'add:file:click'
  	}
  });

  /*global jQuery, _, Backbone, Marionette */
  /**
   *
   * @param {Object} options
   *
   * @param {Object} options.browseButton   Existing and attached DOM node
   * @param {Object} options.uiRegion       Marionette.Region object
   * @param {Object} options.fieldConfig
   *
   * @param {string} options.fieldConfig.file_modal_title
   * @param {string} options.fieldConfig.file_modal_add_button
   * @param {string} options.fieldConfig.file_limit
   * @param {string} options.fieldConfig.limit_extensions
   * @param {string} options.fieldConfig.limit_types
   * @param {string} options.fieldConfig.file_attachment_tab
   *
   * @param {Object} options.fieldConfig.plupload_init
   * @param {Object} options.fieldConfig.plupload_init.browse_button
   *
   * @class
   */
  var PodsFileUploader = Marionette.Object.extend({

    constructor: function constructor(options) {
      // Magically set the object properties we need, they'll just "be there" for the concrete instance
      this.browseButton = options.browseButton;
      this.uiRegion = options.uiRegion;
      this.fieldConfig = options.fieldConfig;

      Marionette.Object.call(this, options);
    }

  });

  /*global jQuery, _, Backbone, Marionette, wp */
  var template$3 = '<ul class="pods-dfv-list-meta media-item">\n\t<% if ( \'\' === errorMsg ) { %>\n\t\t<li class="pods-dfv-list-col pods-progress"><div class="progress-bar" style="width: <%- progress %>%;"></div></li>\n\t<% } %>\n\t<li class="pods-dfv-list-col pods-dfv-list-name"><%- filename %></li>\n</ul>\n<% if ( \'\' !== errorMsg ) { %>\n\t<div class="error"><%- errorMsg %></div>\n<% } %>\n';


  var FileUploadQueueModel = Backbone.Model.extend({
  	defaults: {
  		id: 0,
  		filename: '',
  		progress: 0,
  		errorMsg: ''
  	}
  });

  /**
   *
   */
  var FileUploadQueueItem = Marionette.View.extend({
  	model: FileUploadQueueModel,

  	tagName: 'li',

  	template: _.template(template$3),

  	attributes: function attributes() {
  		return {
  			class: 'pods-dfv-list-item',
  			id: this.model.get('id')
  		};
  	},

  	modelEvents: {
  		'change': 'onModelChanged'
  	},

  	onModelChanged: function onModelChanged() {
  		this.render();
  	}

  });

  /**
   *
   */
  var FileUploadQueue = Marionette.CollectionView.extend({
  	tagName: 'ul',

  	className: 'pods-dfv-list pods-dfv-list-queue',

  	childView: FileUploadQueueItem
  });

  var Plupload = PodsFileUploader.extend({
  	plupload: {},

  	fileUploader: 'plupload',

  	initialize: function initialize() {
  		// Set the browse button argument for plupload... it's required
  		this.fieldConfig['plupload_init']['browse_button'] = this.browseButton;

  		this.plupload = new plupload.Uploader(this.fieldConfig['plupload_init']);
  		this.plupload.init();

  		// Setup all callbacks: ( event_name, callback, context )
  		this.plupload.bind('FilesAdded', this.onFilesAdded, this);
  		this.plupload.bind('UploadProgress', this.onUploadProgress, this);
  		this.plupload.bind('FileUploaded', this.onFileUploaded, this);
  	},

  	/**
    * Fired after files have been selected from the dialog
    *
    * @param up
    * @param files
    */
  	onFilesAdded: function onFilesAdded(up, files) {
  		var model = void 0,
  		    collection = void 0,
  		    view = void 0;

  		// Assemble the collection data for the file queue
  		collection = new Backbone.Collection();
  		jQuery.each(files, function (index, file) {
  			model = new FileUploadQueueModel({
  				id: file.id,
  				filename: file.name
  			});

  			collection.add(model);
  		});

  		// Create a new view based on the collection
  		view = new FileUploadQueue({ collection: collection });
  		view.render(); // Generate the HTML, not attached to the DOM yet

  		// Reset the region in case any error messages are hanging around from a previous upload
  		// and show the new file upload queue
  		this.uiRegion.reset();
  		this.uiRegion.show(view);

  		// Stash references
  		this.queueCollection = collection;

  		up.refresh();
  		up.start();
  	},

  	/**
    *
    * @param up
    * @param file
    */
  	onUploadProgress: function onUploadProgress(up, file) {
  		var model = this.queueCollection.get(file.id);
  		model.set({ progress: file.percent });
  	},

  	/**
    *
    * @param up
    * @param file
    * @param resp
    */
  	onFileUploaded: function onFileUploaded(up, file, resp) {
  		var model = this.queueCollection.get(file.id);
  		var response = resp.response;
  		var newFile = [];

  		// Error condition 1
  		if ("Error: " == resp.response.substr(0, 7)) {
  			response = response.substr(7);
  			if (window.console) {
  				console.log(response);
  			}

  			model.set({
  				progress: 0,
  				errorMsg: response
  			});
  		}
  		// Error condition 2
  		else if ("<e>" == resp.response.substr(0, 3)) {
  				response = jQuery(response).text(); // Strip tags, text only
  				if (window.console) {
  					console.log(response);
  				}

  				model.set({
  					progress: 0,
  					errorMsg: response
  				});
  			} else {
  				var json = response.match(/{.*}$/);

  				if (null !== json && 0 < json.length) {
  					json = jQuery.parseJSON(json[0]);
  				} else {
  					json = {};
  				}

  				if ('object' != (typeof json === 'undefined' ? 'undefined' : babelHelpers.typeof(json)) || jQuery.isEmptyObject(json)) {
  					if (window.console) {
  						console.log(response);
  					}
  					if (window.console) {
  						console.log(json);
  					}

  					model.set({
  						progress: 0,
  						errorMsg: 'There was an issue with the file upload, please try again.'
  					});
  					return;
  				}

  				newFile = {
  					id: json.ID,
  					icon: json.thumbnail,
  					name: json.post_title,
  					edit_link: json.edit_link,
  					link: json.link,
  					download: json.download
  				};

  				// Remove the file from the upload queue model and trigger an event for the hosting container
  				model.trigger('destroy', model);
  				this.trigger('added:files', newFile);
  			}
  	},

  	// This should never be called as plupload intercepts the button click event itself
  	invoke: function invoke() {
  		return;
  	}

  });

  var MediaModal = PodsFileUploader.extend({
  	mediaObject: {},

  	fileUploader: 'attachment',

  	invoke: function invoke() {

  		if (wp.Uploader.defaults.filters.mime_types === undefined) {
  			wp.Uploader.defaults.filters.mime_types = [{ title: 'Allowed Files', extensions: '*' }];
  		}

  		var defaultExt = wp.Uploader.defaults.filters.mime_types[0].extensions;

  		wp.Uploader.defaults.filters.mime_types[0].extensions = this.fieldConfig['limit_extensions'];

  		// set our settings
  		this.mediaObject = wp.media({
  			title: this.fieldConfig['file_modal_title'],
  			multiple: 1 != this.fieldConfig['file_limit'],
  			library: {
  				type: this.fieldConfig['limit_types']
  			},
  			// Customize the submit button.
  			button: {
  				// Set the text of the button.
  				text: this.fieldConfig['file_modal_add_button']
  			}
  		});

  		// One-shot callback ( event, callback, context )
  		this.mediaObject.once('select', this.onMediaSelect, this);

  		// open the frame
  		this.mediaObject.open();
  		this.mediaObject.content.mode(this.fieldConfig['file_attachment_tab']);

  		// Reset the allowed file extensions
  		wp.Uploader.defaults.filters.mime_types[0].extensions = defaultExt;
  	},

  	onMediaSelect: function onMediaSelect() {
  		var selection = this.mediaObject.state().get('selection');
  		var newFiles = [];

  		if (!selection) {
  			return;
  		}

  		// loop through the selected files
  		selection.each(function (attachment) {
  			var sizes = attachment.attributes.sizes;
  			var attachmentThumbnail = void 0;

  			// by default use the generic icon
  			attachmentThumbnail = attachment.attributes.icon;

  			// only thumbnails have sizes which is what we're on the hunt for
  			if (sizes !== undefined) {
  				// Get thumbnail if it exists
  				if (sizes.thumbnail !== undefined && sizes.thumbnail.url !== undefined) {
  					attachmentThumbnail = sizes.thumbnail.url;
  				} // If thumbnail doesn't exist, get full because this is a small image
  				else if (sizes.full !== undefined && sizes.full.url !== undefined) {
  						attachmentThumbnail = sizes.full.url;
  					}
  			}

  			newFiles.push({
  				id: attachment.attributes.id,
  				icon: attachmentThumbnail,
  				name: attachment.attributes.title,
  				edit_link: attachment.attributes.editLink,
  				link: attachment.attributes.link,
  				download: attachment.attributes.url
  			});
  		});

  		// Fire an event with an array of models to be added
  		this.trigger('added:files', newFiles);
  	}

  });

  /*global jQuery, _, Backbone, Marionette */
  var template = '<div class="pods-ui-file-list"></div>\n<div class="pods-ui-region"></div>\n<div class="pods-ui-form"></div>\n';


  var Uploaders = [Plupload, MediaModal];

  var UNLIMITED_FILES = 0;

  /**
   * @extends Backbone.View
   */
  var FileUpload = PodsDFVFieldLayout.extend({
  	template: _.template(template),

  	regions: {
  		list: '.pods-ui-file-list',
  		uiRegion: '.pods-ui-region', // "Utility" container for uploaders to use
  		form: '.pods-ui-form'
  	},

  	uploader: {},

  	/**
    *
    */
  	onBeforeRender: function onBeforeRender() {
  		if (this.collection === undefined) {
  			this.collection = new FileUploadCollection(this.fieldItemData);
  		}
  	},

  	onRender: function onRender() {
  		var listView = new FileUploadList({ collection: this.collection, fieldModel: this.model });
  		var formView = new FileUploadForm({ fieldModel: this.model });

  		this.showChildView('list', listView);
  		this.showChildView('form', formView);

  		// Setup the uploader and listen for a response event
  		this.uploader = this.createUploader();
  		this.listenTo(this.uploader, 'added:files', this.onAddedFiles);
  	},

  	/**
    * Fired by a remove:file:click trigger in any child view
    *
    * @param childView View that was the source of the event
    */
  	onChildviewRemoveFileClick: function onChildviewRemoveFileClick(childView) {
  		this.collection.remove(childView.model);
  	},

  	/**
    * Fired by a add:file:click trigger in any child view
    *
    * plupload fields should never generate this event as it places a shim over our button and handles the event
    * internally
    */
  	onChildviewAddFileClick: function onChildviewAddFileClick() {
  		// Invoke the uploader
  		this.uploader.invoke();
  	},

  	/**
    * Concrete uploader implementations simply need to: this.trigger( 'added:files', newFiles )
    *
    * @param {Object[]} data An array of model objects to be added
    */
  	onAddedFiles: function onAddedFiles(data) {
  		var fieldConfig = this.model.get('fieldConfig');
  		var fileLimit = +fieldConfig['file_limit']; // Unary plus to force to number
  		var newCollection = void 0,
  		    filteredModels = void 0;

  		// Get a copy of the existing collection with the new files added
  		newCollection = this.collection.clone();
  		newCollection.add(data);

  		// Enforce the file limit option if one is set
  		if (UNLIMITED_FILES === fileLimit) {
  			filteredModels = newCollection.models;
  		} else {
  			// Number of uploads is limited: keep the last N models, FIFO/queue style
  			filteredModels = newCollection.filter(function (model) {
  				return newCollection.indexOf(model) >= newCollection.length - fileLimit;
  			});
  		}

  		this.collection.reset(filteredModels);
  	},

  	createUploader: function createUploader() {
  		var fieldConfig = this.model.get('fieldConfig');
  		var targetUploader = fieldConfig['file_uploader'];
  		var Uploader = void 0;

  		jQuery.each(Uploaders, function (index, thisUploader) {
  			if (targetUploader === thisUploader.prototype.fileUploader) {
  				Uploader = thisUploader;
  				return false;
  			}
  		});

  		if (Uploader !== undefined) {
  			this.uploader = new Uploader({
  				// We provide regular DOM element for the button
  				browseButton: this.getRegion('form').getEl('.pods-dfv-list-add').get(),
  				uiRegion: this.getRegion('uiRegion'),
  				fieldConfig: fieldConfig
  			});
  			return this.uploader;
  		} else {
  			throw "Could not locate file uploader '" + targetUploader + "'";
  		}
  	}
  });

  /*global jQuery, _, Backbone, Marionette, wp */

  /**
   * A frame for displaying a modal popup with iframe content
   *
   * @augments wp.media.view.Frame
   */
  var IframeFrame = wp.media.view.Frame.extend({
  	className: 'pods-modal-frame',

  	template: _.template('<div class="media-frame-title" /><div class="media-frame-iframe" />'),

  	regions: ['title', 'iframe'],

  	initialize: function initialize() {
  		wp.media.view.Frame.prototype.initialize.apply(this, arguments);

  		// Ensure core UI is enabled.
  		this.$el.addClass('wp-core-ui');

  		this.initState();
  		this.initModal();

  		this.on('iframe:create:default', this.iframeContent, this);
  		this.iframe.mode('default');

  		this.on('title:create:default', this.createTitle, this);
  		this.title.mode('default');
  		this.on('title:render', function (view) {
  			view.$el.append('<span class="dashicons dashicons-arrow-down"></span>');
  		});
  	},

  	initState: function initState() {
  		var title = this.options.title || 'Add New Record';
  		var src = this.options.src || '/';

  		this.states.add([new wp.media.controller.State({
  			id: 'default',
  			title: title,
  			src: src
  		})]);

  		this.options.state = 'default';
  	},

  	initModal: function initModal() {
  		this.modal = new wp.media.view.Modal({
  			controller: this
  		});

  		this.modal.content(this);
  	},

  	render: function render() {
  		// Activate the default state if no active state exists.
  		if (!this.state() && this.options.state) {
  			this.setState(this.options.state);
  		}
  		/**
     * call 'render' directly on the parent class
     */
  		return wp.media.view.Frame.prototype.render.apply(this, arguments);
  	},

  	/**
    * @param {Object} content
    * @this wp.media.controller.Region
    */
  	iframeContent: function iframeContent(content) {
  		content.view = new wp.media.view.Iframe({
  			controller: this
  		});
  	},

  	createTitle: function createTitle(title) {
  		title.view = new wp.media.View({
  			controller: this,
  			tagName: 'h1'
  		});
  	}
  });

  /*global jQuery, _, Backbone, Marionette */

  /**
   *
   */
  var RelationshipModel = Backbone.Model.extend({
  	defaults: {
  		'id': 0,
  		'name': '',
  		'icon': '',
  		'link': '',
  		'edit_link': '',
  		'selected': false
  	},

  	toggleSelected: function toggleSelected() {
  		this.set('selected', !this.get('selected'));
  	}
  });

  /**
   *
   */
  var RelationshipCollection = Backbone.Collection.extend({
  	model: RelationshipModel,

  	/**
    *
    * @param { ?string[] } ids
    */
  	setSelected: function setSelected(ids) {
  		this.map(function (thisModel) {
  			var selected = _.contains(ids, thisModel.get('id') + '');
  			thisModel.set('selected', selected);
  		});
  	},

  	/**
    * Return a new collection containing just the selected items in this one
    *
    * @returns {*}
    */
  	filterSelected: function filterSelected() {

  		// Get an array with only the selected items
  		var filtered = this.filter(function (itemModel) {
  			return itemModel.get('selected');
  		});

  		// this.filter is going to return an array, so create a collection out of it
  		return new RelationshipCollection(filtered);
  	}
  });

  /*global jQuery, _, Backbone, Marionette */

  var PickFieldModel = Backbone.Model.extend({
  	defaults: {
  		"view_name": "select",
  		"iframe_src": "",
  		"pick_format_type": "single",
  		"pick_show_icon": false,
  		"pick_show_view_link": false,
  		"pick_show_edit_link": false
  	}
  });

  /*global jQuery, _, Backbone, Marionette, wp */
  var template$5 = '<div class="pods-field pods-boolean">\n\t<input\n\t\t\tname="<%- htmlAttr.name %>"\n\t\t\tdata-name-clean="<%- htmlAttr.name_clean %>"\n\t\t\tdata-label="<%- fieldConfig.label %>"\n\t\t\tid="<%- htmlAttr.id %><%= ordinal %>"\n\t\t\tclass="pods-form-ui-field-type-pick pods-form-ui-field-name-<%- htmlAttr.name_clean %>"\n\t\t\ttype="radio"\n\t\t\t<% if ( selected ) { %>\n\t\t\t\tchecked="CHECKED"\n\t\t\t<% } %>\n\t\t\tvalue="<%- id %>"\n\t\t\ttabindex="2">\n\t<label\n\t\tclass="pods-form-ui-label pods-form-ui-label-<%- htmlAttr.id %><%= ordinal %>"\n\t\tfor="<%- htmlAttr.id %><%= ordinal %>">\n\t\t<%= name %>\n\t</label>\n</div>\n';


  /**
   *
   */
  var RadioItem = PodsFieldView.extend({
  	tagName: 'li',

  	template: _.template(template$5),

  	templateContext: function templateContext() {
  		return {
  			ordinal: this.model.collection.indexOf(this.model) + 1 // One based indexing unlike checkboxes
  		};
  	},

  	modelChanged: function modelChanged() {
  		this.render();
  	}

  });

  /**
   *
   */
  var RadioView = PodsFieldListView.extend({
  	tagName: 'ul',

  	className: 'pods-radio',

  	childView: RadioItem
  });

  /*global jQuery, _, Backbone, Marionette, wp */
  var template$6 = '<div class="pods-field pods-boolean">\n\t<input\n\t\tname="<%- htmlAttr.name %>[<%= ordinal %>]"\n\t\t<%= selected ? \'checked="checked"\' : \'\' %>\n\t\tdata-name-clean="<%- htmlAttr.name_clean %>"\n\t\tdata-label="<%- fieldConfig.label %>"\n\t\tid="<%- htmlAttr.id %><%= ordinal %>"\n\t\tclass="pods-form-ui-field-type-pick"\n\t\ttype="checkbox" tabindex="2" value="<%- id %>">\n\t<label class="pods-form-ui-label" for="<%- htmlAttr.id %><%= ordinal %>">\n\t\t<%= name %>\n\t</label>\n</div>\n';


  /**
   *
   */
  var CheckboxItem = PodsFieldView.extend({
  	tagName: 'li',

  	template: _.template(template$6),

  	className: 'pods-pick',

  	ui: {
  		checkbox: 'input.pods-form-ui-field-type-pick'
  	},

  	triggers: {
  		'click @ui.checkbox': 'toggle:selected'
  	},

  	modelEvents: {
  		'change': 'modelChanged'
  	},

  	templateContext: function templateContext() {
  		return {
  			ordinal: this.model.collection.indexOf(this.model)
  		};
  	},

  	modelChanged: function modelChanged() {
  		this.render();
  	},

  	onToggleSelected: function onToggleSelected() {
  		this.model.toggleSelected();
  	}
  });

  /**
   *
   */
  var CheckboxView = PodsFieldListView.extend({
  	tagName: 'ul',

  	className: 'pods-checkbox-view',

  	childView: CheckboxItem
  });

  /**
   * option
   *
   * @extends Backbone.View
   */
  var SelectItem = PodsFieldView.extend({
  	tagName: 'option',

  	template: false,

  	initialize: function initialize(options) {
  		this.$el.val(this.model.get('id'));

  		this.$el.html(this.model.get('name'));

  		if (this.model.get('selected')) {
  			this.$el.prop('selected', 'selected');
  		}
  	}
  });

  /**
   * optgroup
   *
   * @extends Backbone.View
   */
  var Optgroup = PodsFieldListView.extend({
  	tagName: 'optgroup',
  	childView: SelectItem,

  	attributes: function attributes() {
  		return {
  			label: this.model.get('label')
  		};
  	}
  });

  /**
   * select
   *
   * @extends Backbone.View
   */
  var SelectView = Marionette.CollectionView.extend({
  	tagName: 'select',

  	triggers: {
  		"change": {
  			event: "change:selected",
  			stopPropagation: false
  		}
  	},

  	initialize: function initialize(options) {
  		this.fieldModel = options.fieldModel;
  		this.fieldConfig = this.fieldModel.get('fieldConfig');
  	},

  	/**
    * Set the proper child view (optgroups or no)
    *
    * @param item
    * @returns {*}
    */
  	childView: function childView(item) {
  		if (this.fieldConfig.optgroup) {
  			return Optgroup;
  		} else {
  			return SelectItem;
  		}
  	},

  	/**
    * todo: We're bypassing the PodsFieldListView functionality, need to explicitly include it for now
    *
    * @param model
    * @param index
    * @returns {{fieldModel: *}}
    */
  	childViewOptions: function childViewOptions(model, index) {
  		var returnOptions = { fieldModel: this.fieldModel };

  		if (this.fieldConfig.optgroup) {
  			returnOptions.collection = new RelationshipCollection(model.get('collection'));
  		}

  		return returnOptions;
  	},

  	/**
    * todo: We're bypassing the PodsFieldListView functionality, need to explicitly include it for now
    *
    * @returns {{}}
    */
  	serializeData: function serializeData() {
  		var fieldModel = this.options.fieldModel;
  		var data = this.model ? this.model.toJSON() : {};

  		data.htmlAttr = fieldModel.get('attributes');
  		data.fieldConfig = fieldModel.get('fieldConfig');

  		return data;
  	},

  	/**
    *
    */
  	attributes: function attributes() {

  		/**
     * @param {string} htmlAttr.name
     * @param {string} htmlAttr.class
     * @param {string} htmlAttr.name_clean
     * @param {string} htmlAttr.id
     *
     * @param {string} fieldConfig.pick_format_type 'single' or 'multi'
     */
  		var fieldModel = this.options.fieldModel;
  		var htmlAttr = fieldModel.get('htmlAttr');
  		var fieldConfig = fieldModel.get('fieldConfig');

  		var name = htmlAttr.name;
  		if (fieldConfig.pick_format_type === 'multi') {
  			name = name + '[]';
  		}
  		return {
  			'name': name,
  			'class': htmlAttr.class,
  			'data-name-clean': htmlAttr.name_clean,
  			'id': htmlAttr.id,
  			'tabindex': '2',
  			'multiple': fieldConfig.pick_format_type === 'multi'
  		};
  	},

  	onAttach: function onAttach() {
  		if (this.fieldConfig.view_name === 'select2') {
  			this.$el.select2();
  		}
  	},

  	/**
    *
    */
  	onChangeSelected: function onChangeSelected() {
  		this.collection.setSelected(this.$el.val());
  	}

  });

  /*global jQuery, _, Backbone, Marionette, wp */
  var template$7 = '<input name="<%- htmlAttr.name %>[<%= ordinal %>]"\n\t\tdata-name-clean="<%- htmlAttr.name_clean %>"\n\t\tid="<%- htmlAttr.id %><%= ordinal %>"\n\t\ttype="hidden"\n\t\tvalue="<%- id %>>">\n<ul class="pods-dfv-list-meta relationship-item">\n\t<li class="pods-dfv-list-col pods-dfv-list-handle"><span>Reorder</span></li>\n\t<% if ( 1 == fieldConfig.pick_show_icon && \'\' != icon ) { %>\n\t\t<li class="pods-dfv-list-col pods-dfv-list-icon">\n\t\t\t<img class="pinkynail" src="<%- icon %>" alt="Icon">\n\t\t</li>\n\t<% } %>\n\t<li class="pods-dfv-list-col pods-dfv-list-name">\n\t\t<%= name %>\n\t</li>\n\t<li class="pods-dfv-list-col pods-dfv-list-remove"><a href="#remove">Remove</a></li>\n\t<% if ( 1 == fieldConfig.pick_show_view_link && \'\' != link ) { %>\n\t\t<li class="pods-dfv-list-col pods-dfv-list-link"><a href="<%- link %>" target="_blank">View</a></li>\n\t<% } %>\n\t<% if ( 1 == fieldConfig.pick_show_edit_link && \'\' != edit_link ) { %>\n\t\t<li class="pods-dfv-list-col pods-dfv-list-edit"><a href="<%- edit_link %>" target="_blank">Edit</a></li>\n\t<% } %>\n</ul>\n';


  /**
   *
   */
  var ListItem = PodsFieldView.extend({
  	tagName: 'li',

  	className: 'pods-dfv-list-item pods-relationship',

  	template: _.template(template$7),

  	ui: {
  		removeButton: '.pods-dfv-list-remove a'
  	},

  	triggers: {
  		'click @ui.removeButton': 'remove:item:click'
  	},

  	templateContext: function templateContext() {
  		return {
  			ordinal: this.model.collection.indexOf(this.model)
  		};
  	}

  });

  /**
   *  Represents the markup of the container as a whole
   */
  var ListView = PodsFieldListView.extend({ // Cache the template function for the overall container
  	tagName: 'ul',

  	className: 'pods-dfv-list pods-relationship',

  	childView: ListItem,

  	filter: function filter(child, index, collection) {
  		return child.attributes.selected;
  	},

  	onAttach: function onAttach() {

  		// @todo
  		// http://stackoverflow.com/questions/1735372/jquery-sortable-list-scroll-bar-jumps-up-when-sorting/4187833#4187833

  		// init sortable
  		this.$el.sortable({
  			containment: 'parent',
  			axis: 'y',
  			scrollSensitivity: 40,
  			tolerance: 'pointer',
  			opacity: 0.6
  		});
  	}

  });

  /*global jQuery, _, Backbone, Marionette, wp */
  var template$8 = '<a href="/wp-admin/?pods_modal=1"\n\t\tclass="button pods-related-add-new pods-modal"\n\t\tdata-pod-id="<%- fieldConfig.pod_id %>"\n\t\tdata-field-id="<%- fieldConfig.id %>"\n\t\tdata-item-id="<%- fieldConfig.item_id %>">\n\tAdd New\n</a>';


  var AddNew = PodsFieldView.extend({
  	tagName: 'div',

  	className: 'podsform-dfv-list-relationship-container',

  	ui: {
  		addButton: '.pods-related-add-new'
  	},

  	template: _.template(template$8),

  	triggers: {
  		'click @ui.addButton': 'add:new:click'
  	}
  });

  /*global jQuery, _, Backbone, Marionette, wp */
  var template$4 = '<div class="pods-pick-values"></div>\n<% if ( fieldConfig.iframe_src != \'\' ) { %>\n\t<div class="pods-ui-add-new"></div>\n<% } %>';


  var views = {
  	'checkbox': CheckboxView,
  	'select': SelectView,
  	'select2': SelectView, // SelectView handles select2 as well
  	'radio': RadioView,
  	'list': ListView
  };

  /**
   * @extends Backbone.View
   */
  var Pick = PodsDFVFieldLayout.extend({
  	template: _.template(template$4),

  	regions: {
  		list: '.pods-pick-values',
  		addNew: '.pods-ui-add-new'
  	},

  	/**
    *
    */
  	onBeforeRender: function onBeforeRender() {
  		if (this.collection === undefined) {
  			this.collection = new RelationshipCollection(this.fieldItemData);
  		}
  	},

  	/**
    *
    */
  	onRender: function onRender() {
  		var viewName = void 0,
  		    View = void 0,
  		    list = void 0,
  		    addNew = void 0;

  		this.fieldConfig = new PickFieldModel(this.model.get('fieldConfig'));

  		// Setup the view to be used
  		viewName = this.fieldConfig.get('view_name');
  		if (views[viewName] === undefined) {
  			throw new Error('Invalid view name "' + viewName + '"');
  		}
  		View = views[viewName];
  		list = new View({ collection: this.collection, fieldModel: this.model });
  		this.showChildView('list', list);

  		// Show Add New?
  		if (this.fieldConfig.get('iframe_src') !== '') {
  			addNew = new AddNew({ fieldModel: this.model });
  			this.showChildView('addNew', addNew);
  		}
  	},

  	/**
    * "Remove" in list view just toggles an item's selected attribute
    *
    * @param childView
    * @param args
    */
  	onChildviewRemoveItemClick: function onChildviewRemoveItemClick(childView, args) {
  		var list = this.childView('list');

  		args.model.toggleSelected();
  		list.render();
  	},

  	/**
    * @param childView
    */
  	onChildviewAddNewClick: function onChildviewAddNewClick(childView) {
  		var fieldConfig = this.model.get('fieldConfig');

  		var modalFrame = new IframeFrame({
  			title: 'The Title',
  			src: fieldConfig.iframe_src
  		});
  		modalFrame.modal.open();
  	},

  	/**
    * @param response
    */
  	addNewSuccess: function addNewSuccess(response) {
  		console.log(response);
  	}

  });



  var fields = Object.freeze({
  	FileUpload: FileUpload,
  	Pick: Pick
  });

  // jQuery selector for inline scripts with field definitions
  var SCRIPT_TARGET = 'script.pods-dfv-field-data';

  // key: FieldClass
  var FieldClasses = {
  	'file-upload': FileUpload,
  	'pick': Pick
  };

  /**
   * Custom jQuery plugin to handle Pods MV Fields
   *
   * @param {Object} fields Object to which new fields will be added, in { fieldId: fieldInstance } format
   */
  var PodsDFVInit = function PodsDFVInit(fields) {

  	return this.each(function () {
  		var data = void 0,
  		    FieldClass = void 0,
  		    newField = void 0,
  		    fieldModel = void 0;

  		data = { fieldType: '' };

  		// Combine data from all in-line data scripts in the container
  		jQuery(this).find(SCRIPT_TARGET).each(function () {
  			var thisData = jQuery.parseJSON(jQuery(this).html());
  			jQuery.extend(data, thisData);
  			jQuery(this).remove();
  		});

  		// Ignore anything that doesn't have the field type set
  		if (data.fieldType !== undefined) {

  			// Lookup the class to instantiate by key
  			FieldClass = FieldClasses[data.fieldType];

  			if (FieldClass !== undefined) {
  				// Assemble the model
  				fieldModel = new PodsDFVFieldModel({
  					htmlAttr: data.htmlAttr,
  					fieldConfig: data.fieldConfig
  				});

  				newField = new FieldClass({
  					el: this,
  					model: fieldModel,
  					fieldItemData: data.fieldItemData
  				});

  				// Render the field, stash a reference, trigger an event for the outside world
  				newField.render();
  				fields[data.htmlAttr.id] = newField;
  				jQuery(this).trigger('render');
  			}
  		}
  	});
  };



  var models = Object.freeze({
  	PodsDFVFieldModel: PodsDFVFieldModel,
  	RelationshipModel: RelationshipModel,
  	RelationshipCollection: RelationshipCollection,
  	FileUploadModel: FileUploadModel,
  	FileUploadCollection: FileUploadCollection
  });

  var PodsDFV = {
  	fields: fields,
  	models: models,
  	fieldInstances: {}
  };
  /**
   * This is the workhorse that currently kicks everything off
   */
  jQuery.fn.PodsDFVInit = PodsDFVInit;
  jQuery(function () {
  	jQuery('.pods-form-ui-field').PodsDFVInit(PodsDFV.fieldInstances);
  });

  return PodsDFV;

}());