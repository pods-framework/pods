var PodsDFV=function(){"use strict";var e={};e["typeof"]="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e};var i=Backbone.Model.extend({defaults:{htmlAttr:{},fieldConfig:{}}}),t=Marionette.CollectionView.extend({initialize:function(e){this.fieldModel=e.fieldModel,this.childViewOptions={fieldModel:e.fieldModel}}}),l=Marionette.View.extend({serializeData:function(){var e=this.options.fieldModel,i=this.model?this.model.toJSON():{};return i.htmlAttr=e.get("htmlAttr"),i.fieldConfig=e.get("fieldConfig"),i}}),n=Marionette.View.extend({initialize:function(e){this.fieldItemData=e.fieldItemData}}),o=Backbone.Model.extend({defaults:{id:0,icon:"",name:"",edit_link:"",link:"",download:""}}),d=Backbone.Collection.extend({model:o}),s='<input\n	name="<%- htmlAttr.name %>[<%- id %>][id]"\n	data-name-clean="<%- htmlAttr.name_clean %>-id"\n	id="<%- htmlAttr.id %>-<%- id %>-id"\n	class="<%- htmlAttr.class %>"\n	type="hidden"\n	value="<%- id %>" />\n<ul class="pods-dfv-list-meta media-item">\n	<% if ( 1 != fieldConfig.file_limit ) { %>\n		<li class="pods-dfv-list-col pods-dfv-list-handle"><span><%- PodsI18n.__( \'Reorder\' ) %></span></li>\n	<% } %>\n	<li class="pods-dfv-list-col pods-dfv-list-icon"><img class="pinkynail" src="<%- icon %>" alt="<%- PodsI18n.__( \'Icon\' ) %>"></li>\n	<li class="pods-dfv-list-col pods-dfv-list-name">\n		<% if ( 0 != fieldConfig.file_edit_title ) { %>\n			<input\n				name="<%- htmlAttr.name %>[<%- id %>][title]"\n				data-name-clean="<%- htmlAttr.name_clean %>-title"\n				id="pods-form-ui-<%- htmlAttr.name_clean %>-<%- id %>-title"\n				class="pods-form-ui-field-type-text pods-form-ui-field-name-<%- htmlAttr.name_clean %>-title"\n				type="text"\n				value="<%- name %>"\n				tabindex="2"\n				maxlength="255" />\n		<% } else { %>\n			<%- name %>\n		<% } %>\n	</li>\n	<li class="pods-dfv-list-col pods-dfv-list-actions">\n		<ul>\n			<li class="pods-dfv-list-col pods-dfv-list-remove"><a href="#remove"><%- PodsI18n.__( \'Remove\' ) %></a></li>\n			<% if ( 1 == fieldConfig.file_linked && \'\' != download ) { %>\n				<li class="pods-dfv-list-col pods-dfv-list-download"><a href="<%- download %>" target="_blank"><%- PodsI18n.__( \'Download\' ) %></a></li>\n			<% } %>\n			<% if ( 1 == fieldConfig.file_show_view_link && \'\' != link ) { %>\n				<li class="pods-dfv-list-col pods-dfv-list-link"><a href="<%- link %>" target="_blank"><%- PodsI18n.__( \'View\' ) %></a></li>\n			<% } %>\n			<% if ( 1 == fieldConfig.file_show_edit_link && \'\' != edit_link ) { %>\n				<li class="pods-dfv-list-col pods-dfv-list-edit"><a href="<%- edit_link %>" target="_blank"><%- PodsI18n.__( \'Edit\' ) %></a></li>\n			<% } %>\n		</ul>\n	</li>\n</ul>\n',a=l.extend({tagName:"li",className:"pods-dfv-list-item",ui:{dragHandle:".pods-dfv-list-handle",editLink:".pods-dfv-list-edit-link",viewLink:".pods-dfv-list-link",downloadLink:".pods-dfv-list-download",removeButton:".pods-dfv-list-remove",itemName:".pods-dfv-list-name"},template:_.template(s),triggers:{"click @ui.removeButton":"remove:file:click"}}),r=t.extend({tagName:"ul",className:"pods-dfv-list",childView:a,onAttach:function(){var e=this.options.fieldModel.get("fieldConfig");if(1!=e.file_limit){var i="y";"tiles"==e.file_field_template&&(i=""),this.$el.sortable({containment:"parent",axis:i,scrollSensitivity:40,tolerance:"pointer",opacity:.6})}}}),c='<a class="button pods-dfv-list-add" href="#" tabindex="2"><%= fieldConfig.file_add_button %></a>',f=l.extend({tagName:"div",ui:{addButton:".pods-dfv-list-add"},template:_.template(c),triggers:{"click @ui.addButton":"add:file:click"}}),m=Marionette.Object.extend({constructor:function(e){this.browseButton=e.browseButton,this.uiRegion=e.uiRegion,this.fieldConfig=e.fieldConfig,Marionette.Object.call(this,e)}}),p='<ul class="pods-dfv-list-meta media-item">\n	<% if ( \'\' === errorMsg ) { %>\n		<li class="pods-dfv-list-col pods-progress"><div class="progress-bar" style="width: <%- progress %>%;"></div></li>\n	<% } %>\n	<li class="pods-dfv-list-col pods-dfv-list-name"><%- filename %></li>\n</ul>\n<% if ( \'\' !== errorMsg ) { %>\n	<div class="error"><%- errorMsg %></div>\n<% } %>\n',h=Backbone.Model.extend({defaults:{id:0,filename:"",progress:0,errorMsg:""}}),u=Marionette.View.extend({model:h,tagName:"li",template:_.template(p),attributes:function(){return{"class":"pods-dfv-list-item",id:this.model.get("id")}},modelEvents:{change:"onModelChanged"},onModelChanged:function(){this.render()}}),g=Marionette.CollectionView.extend({tagName:"ul",className:"pods-dfv-list pods-dfv-list-queue",childView:u}),v=m.extend({plupload:{},fileUploader:"plupload",initialize:function(){this.fieldConfig.plupload_init.browse_button=this.browseButton,this.plupload=new plupload.Uploader(this.fieldConfig.plupload_init),this.plupload.init(),this.plupload.bind("FilesAdded",this.onFilesAdded,this),this.plupload.bind("UploadProgress",this.onUploadProgress,this),this.plupload.bind("FileUploaded",this.onFileUploaded,this)},onFilesAdded:function(e,i){var t=void 0,l=void 0,n=void 0;l=new Backbone.Collection,jQuery.each(i,function(e,i){t=new h({id:i.id,filename:i.name}),l.add(t)}),n=new g({collection:l}),n.render(),this.uiRegion.reset(),this.uiRegion.show(n),this.queueCollection=l,e.refresh(),e.start()},onUploadProgress:function(e,i){var t=this.queueCollection.get(i.id);t.set({progress:i.percent})},onFileUploaded:function(i,t,l){var n=this.queueCollection.get(t.id),o=l.response,d=[],s=void 0;if("Error: "==l.response.substr(0,7))o=o.substr(7),window.console&&console.log(o),n.set({progress:0,errorMsg:o});else if("<e>"==l.response.substr(0,3))o=jQuery(o).text(),window.console&&console.log(o),n.set({progress:0,errorMsg:o});else{if(s=o.match(/{.*}$/),s=null!==s&&0<s.length?jQuery.parseJSON(s[0]):{},"object"!=("undefined"==typeof s?"undefined":e["typeof"](s))||jQuery.isEmptyObject(s))return window.console&&console.log(o),window.console&&console.log(s),void n.set({progress:0,errorMsg:PodsI18n.__("Error uploading file: ")+t.name});d={id:s.ID,icon:s.thumbnail,name:s.post_title,edit_link:s.edit_link,link:s.link,download:s.download},n.trigger("destroy",n),this.trigger("added:files",d)}}}),w=m.extend({mediaObject:{},fileUploader:"attachment",invoke:function(){void 0===wp.Uploader.defaults.filters.mime_types&&(wp.Uploader.defaults.filters.mime_types=[{title:PodsI18n.__("Allowed Files"),extensions:"*"}]);var e=wp.Uploader.defaults.filters.mime_types[0].extensions;wp.Uploader.defaults.filters.mime_types[0].extensions=this.fieldConfig.limit_extensions,this.mediaObject=wp.media({title:this.fieldConfig.file_modal_title,multiple:1!=this.fieldConfig.file_limit,library:{type:this.fieldConfig.limit_types},button:{text:this.fieldConfig.file_modal_add_button}}),this.mediaObject.once("select",this.onMediaSelect,this),this.mediaObject.open(),this.mediaObject.content.mode(this.fieldConfig.file_attachment_tab),wp.Uploader.defaults.filters.mime_types[0].extensions=e},onMediaSelect:function(){var e=this.mediaObject.state().get("selection"),i=[];e&&(e.each(function(e){var t=e.attributes.sizes,l=void 0;l=e.attributes.icon,void 0!==t&&(void 0!==t.thumbnail&&void 0!==t.thumbnail.url?l=t.thumbnail.url:void 0!==t.full&&void 0!==t.full.url&&(l=t.full.url)),i.push({id:e.attributes.id,icon:l,name:e.attributes.title,edit_link:e.attributes.editLink,link:e.attributes.link,download:e.attributes.url})}),this.trigger("added:files",i))}}),C='<div class="pods-ui-file-list"></div>\n<div class="pods-ui-region"></div>\n<div class="pods-ui-form"></div>\n',b=[v,w],k=0,y=n.extend({template:_.template(C),regions:{list:".pods-ui-file-list",uiRegion:".pods-ui-region",form:".pods-ui-form"},uploader:{},onBeforeRender:function(){void 0===this.collection&&(this.collection=new d(this.fieldItemData))},onRender:function(){var e=new r({collection:this.collection,fieldModel:this.model}),i=new f({fieldModel:this.model});this.showChildView("list",e),this.showChildView("form",i),this.uploader=this.createUploader(),this.listenTo(this.uploader,"added:files",this.onAddedFiles)},onChildviewRemoveFileClick:function(e){this.collection.remove(e.model)},onChildviewAddFileClick:function(){this.uploader.invoke()},onAddedFiles:function(e){var i=this.model.get("fieldConfig"),t=+i.file_limit,l=void 0,n=void 0;l=this.collection.clone(),l.add(e),n=k===t?l.models:l.filter(function(e){return l.indexOf(e)>=l.length-t}),this.collection.reset(n)},createUploader:function(){var e=this.model.get("fieldConfig"),i=e.file_uploader,t=void 0;if(jQuery.each(b,function(e,l){return i===l.prototype.fileUploader?(t=l,!1):void 0}),void 0!==t)return this.uploader=new t({browseButton:this.getRegion("form").getEl(".pods-dfv-list-add").get(),uiRegion:this.getRegion("uiRegion"),fieldConfig:e}),this.uploader;throw"Could not locate file uploader '"+i+"'"}}),x=wp.media.view.Frame.extend({className:"pods-modal-frame",template:_.template('<div class="media-frame-title" /><div class="media-frame-iframe" />'),regions:["title","iframe"],initialize:function(){wp.media.view.Frame.prototype.initialize.apply(this,arguments),this.$el.addClass("wp-core-ui"),this.initState(),this.initModal(),this.on("iframe:create:default",this.iframeContent,this),this.iframe.mode("default"),this.on("title:create:default",this.createTitle,this),this.title.mode("default"),this.on("title:render",function(e){e.$el.append('<span class="dashicons dashicons-arrow-down"></span>')})},initState:function(){var e=this.options.title||PodsI18n.__("Add New Record"),i=this.options.src||"/";this.states.add([new wp.media.controller.State({id:"default",title:e,src:i})]),this.options.state="default"},initModal:function(){this.modal=new wp.media.view.Modal({controller:this}),this.modal.content(this)},render:function(){return!this.state()&&this.options.state&&this.setState(this.options.state),wp.media.view.Frame.prototype.render.apply(this,arguments)},iframeContent:function(e){e.view=new wp.media.view.Iframe({controller:this})},createTitle:function(e){e.view=new wp.media.View({controller:this,tagName:"h1"})}}),A=Backbone.Model.extend({defaults:{id:0,name:"",icon:"",use_dashicon:!1,link:"",edit_link:"",selected:!1},toggleSelected:function(){this.set("selected",!this.get("selected"))}}),M=Backbone.Collection.extend({model:A,setSelected:function(e){this.map(function(i){var t=_.contains(e,i.get("id")+"");i.set("selected",t)})},filterBySelected:function(){var e=this.filter(function(e){return e.get("selected")});return new M(e)},filterByUnselected:function(){var e=this.filter(function(e){return!e.get("selected")});return new M(e)}}),N=Backbone.Model.extend({defaults:{view_name:"select",iframe_src:"",pick_format_type:"single",pick_show_icon:!1,pick_show_view_link:!1,pick_show_edit_link:!1}}),I='<div class="pods-field pods-boolean">\n	<input\n			name="<%- htmlAttr.name %>"\n			data-name-clean="<%- htmlAttr.name_clean %>"\n			data-label="<%- fieldConfig.label %>"\n			id="<%- htmlAttr.id %><%= ordinal %>"\n			class="pods-form-ui-field-type-pick pods-form-ui-field-name-<%- htmlAttr.name_clean %>"\n			type="radio"\n			<% if ( selected ) { %>\n				checked="CHECKED"\n			<% } %>\n			value="<%- id %>"\n			tabindex="2">\n	<label\n		class="pods-form-ui-label pods-form-ui-label-<%- htmlAttr.id %><%= ordinal %>"\n		for="<%- htmlAttr.id %><%= ordinal %>">\n		<%= name %>\n	</label>\n</div>\n',V=l.extend({tagName:"li",template:_.template(I),templateContext:function(){return{ordinal:this.model.collection.indexOf(this.model)+1}},modelChanged:function(){this.render()}}),j=t.extend({tagName:"ul",className:"pods-radio",childView:V}),S='<div class="pods-field pods-boolean">\n	<input\n		name="<%- htmlAttr.name %>[<%= ordinal %>]"\n		<%= selected ? \'checked="checked"\' : \'\' %>\n		data-name-clean="<%- htmlAttr.name_clean %>"\n		data-label="<%- fieldConfig.label %>"\n		id="<%- htmlAttr.id %><%= ordinal %>"\n		class="pods-form-ui-field-type-pick"\n		type="checkbox" tabindex="2" value="<%- id %>">\n	<label class="pods-form-ui-label" for="<%- htmlAttr.id %><%= ordinal %>">\n		<%= name %>\n	</label>\n</div>\n',B=l.extend({tagName:"li",template:_.template(S),className:"pods-pick",ui:{checkbox:"input.pods-form-ui-field-type-pick"},triggers:{"click @ui.checkbox":"toggle:selected"},modelEvents:{change:"modelChanged"},templateContext:function(){return{ordinal:this.model.collection.indexOf(this.model)}},modelChanged:function(){this.render()},onToggleSelected:function(){this.model.toggleSelected()}}),F=t.extend({tagName:"ul",className:"pods-checkbox-view",childView:B}),P=l.extend({tagName:"option",template:!1,initialize:function(e){this.$el.val(this.model.get("id")),this.$el.html(this.model.get("name")),this.model.get("selected")&&this.$el.prop("selected","selected")}}),U=t.extend({tagName:"optgroup",childView:P,attributes:function(){return{label:this.model.get("label")}}}),R=Marionette.CollectionView.extend({tagName:"select",triggers:{change:{event:"change:selected",stopPropagation:!1}},initialize:function(e){this.fieldModel=e.fieldModel,this.fieldConfig=this.fieldModel.get("fieldConfig")},childView:function(e){return this.fieldConfig.optgroup?U:P},childViewOptions:function(e,i){var t={fieldModel:this.fieldModel};return this.fieldConfig.optgroup&&(t.collection=new M(e.get("collection"))),t},serializeData:function(){var e=this.options.fieldModel,i=this.model?this.model.toJSON():{};return i.htmlAttr=e.get("attributes"),i.fieldConfig=e.get("fieldConfig"),i},attributes:function(){var e=this.options.fieldModel,i=e.get("htmlAttr"),t=e.get("fieldConfig"),l=i.name;return"multi"===t.pick_format_type&&(l+="[]"),{name:l,"class":i["class"],"data-name-clean":i.name_clean,id:i.id,tabindex:"2",multiple:"multi"===t.pick_format_type}},onAttach:function(){"select2"===this.fieldConfig.view_name&&this.setupSelect2()},onChangeSelected:function(){this.collection.setSelected(this.$el.val())},setupSelect2:function(){var e="ul.select2-selection__rendered",i=".select2-selection__choice",t=this.$el,l=void 0;t.select2(),l=t.parent().find(e),l.sortable({containment:"parent"}),l.on("sortstop",function(){var e=l.find(i).get().reverse();jQuery(e).each(function(){var e=jQuery(this).data("data").id,i=t.find('option[value="'+e+'"]')[0];t.prepend(i)})})}}),O='<input name="<%- htmlAttr.name %>[<%= ordinal %>]"\n		data-name-clean="<%- htmlAttr.name_clean %>"\n		id="<%- htmlAttr.id %><%= ordinal %>"\n		type="hidden"\n		value="<%- id %>">\n<ul class="pods-dfv-list-meta relationship-item">\n	<% if ( 1 != fieldConfig.pick_limit ) { %>\n		<li class="pods-dfv-list-col pods-dfv-list-handle"><span><%- PodsI18n.__( \'Reorder\' ) %></span></li>\n	<% } %>\n	<% if ( 1 == fieldConfig.pick_show_icon && \'\' != icon ) { %>\n		<li class="pods-dfv-list-col pods-dfv-list-icon">\n			<% if ( use_dashicon ) { %>\n			<span class="pinkynail dashicons <%- icon %>"></span>\n			<% } else { %>\n			<img class="pinkynail" src="<%- icon %>" alt="Icon">\n			<% } %>\n		</li>\n	<% } %>\n	<li class="pods-dfv-list-col pods-dfv-list-name">\n		<%= name %>\n	</li>\n	<li class="pods-dfv-list-col pods-dfv-list-remove"><a href="#remove"><%- PodsI18n.__( \'Remove\' ) %></a></li>\n	<% if ( 1 == fieldConfig.pick_show_view_link && \'\' != link ) { %>\n		<li class="pods-dfv-list-col pods-dfv-list-link"><a href="<%- link %>" target="_blank"><%- PodsI18n.__( \'View\' ) %></a></li>\n	<% } %>\n	<% if ( 1 == fieldConfig.pick_show_edit_link && \'\' != edit_link ) { %>\n		<li class="pods-dfv-list-col pods-dfv-list-edit"><a href="<%- edit_link %>" target="_blank"><%- PodsI18n.__( \'Edit\' ) %></a></li>\n	<% } %>\n</ul>\n',Q=l.extend({tagName:"li",className:"pods-dfv-list-item pods-relationship",template:_.template(O),ui:{removeButton:".pods-dfv-list-remove a",editButton:".pods-dfv-list-edit a"},triggers:{"click @ui.removeButton":"remove:item:click","click @ui.editButton":"edit:item:click"},templateContext:function(){return{ordinal:this.model.collection.indexOf(this.model)}}}),D=t.extend({tagName:"ul",className:"pods-dfv-list pods-relationship",childView:Q,filter:function(e,i,t){return e.attributes.selected},onAttach:function(){var e=this.options.fieldModel.get("fieldConfig");1!==e.pick_limit&&this.$el.sortable({containment:"parent",axis:"y",scrollSensitivity:40,tolerance:"pointer",opacity:.6})}}),E='<a href="/wp-admin/?pods_modal=1"\n		class="button pods-related-add-new pods-modal"\n		data-pod-id="<%- fieldConfig.pod_id %>"\n		data-field-id="<%- fieldConfig.id %>"\n		data-item-id="<%- fieldConfig.item_id %>">\n	<%- PodsI18n.__( \'Add New\' ) %>\n</a>',z=l.extend({tagName:"div",className:"podsform-dfv-list-relationship-container",ui:{addButton:".pods-related-add-new"},template:_.template(E),triggers:{"click @ui.addButton":"add:new:click"}}),$='<%if ( fieldConfig.view_name === \'list\' ) { %>\n	<div class="pods-ui-list-autocomplete"></div>\n<% } %>\n\n<div class="pods-pick-values"></div>\n\n<% if ( fieldConfig.iframe_src != \'\' ) { %>\n	<div class="pods-ui-add-new"></div>\n<% } %>',T={checkbox:F,select:R,select2:R,radio:j,list:D},L=void 0,q=n.extend({template:_.template($),regions:{autocomplete:".pods-ui-list-autocomplete",list:".pods-pick-values",addNew:".pods-ui-add-new"},onBeforeRender:function(){void 0===this.collection&&(this.collection=new M(this.fieldItemData))},onRender:function(){this.fieldConfig=new N(this.model.get("fieldConfig")),"list"===this.fieldConfig.get("view_name")&&this.showAutocomplete(),this.showList(),""!==this.fieldConfig.get("iframe_src")&&1==this.fieldConfig.get("pick_allow_add_new")&&this.showAddNew()},showAutocomplete:function(){var e={view_name:"select2",pick_format_type:"multi",selectFromExisting:!0},t=new i({fieldConfig:e}),l=this.collection.filterByUnselected(),n=new R({collection:l,fieldModel:t});this.showChildView("autocomplete",n)},showList:function(){var e=void 0,i=void 0,t=void 0;if(e=this.fieldConfig.get("view_name"),void 0===T[e])throw new Error('Invalid view name "'+e+'"');i=T[e],t=new i({collection:this.collection,fieldModel:this.model}),this.showChildView("list",t)},showAddNew:function(){var e=new z({fieldModel:this.model});this.showChildView("addNew",e)},refreshAutocomplete:function(){var e=this.getChildView("autocomplete");e.collection=this.collection.filterByUnselected(),e.render()},onChildviewRemoveItemClick:function(e){e.model.toggleSelected(),this.getChildView("list").render(),"list"===this.fieldConfig.get("view_name")&&this.refreshAutocomplete()},onChildviewAddNewClick:function(e){var i=this.model.get("fieldConfig");L=new x({title:i.iframe_title,src:i.iframe_src}),jQuery(window).on("dfv:modal:update",this.modalSuccess.bind(this)),L.modal.open()},onChildviewEditItemClick:function(e){var i=this.model.get("fieldConfig");L=new x({title:i.iframe_title,src:e.ui.editButton.attr("href")}),jQuery(window).on("dfv:modal:update",this.modalSuccess.bind(this)),L.modal.open()},onChildviewChangeSelected:function(e){e.fieldConfig.selectFromExisting&&(this.refreshAutocomplete(),this.getChildView("list").render())},modalSuccess:function(e,i){var t=this.collection.get(i.id);t?(t.set(i),this.getChildView("list").render()):this.collection.add(i),L.modal.close()}}),J=Object.freeze({FileUpload:y,Pick:q}),H="script.pods-dfv-field-data",K={file:y,avatar:y,pick:q},G=function(e){return this.each(function(){var t=void 0,l=void 0,n=void 0,o=void 0;t={fieldType:""},jQuery(this).find(H).each(function(){var e=jQuery.parseJSON(jQuery(this).html());jQuery.extend(t,e),jQuery(this).remove()}),void 0!==t.fieldType&&(l=K[t.fieldType],void 0!==l&&(o=new i({htmlAttr:t.htmlAttr,fieldConfig:t.fieldConfig}),n=new l({el:this,model:o,fieldItemData:t.fieldItemData}),n.render(),e[t.htmlAttr.id]=n,jQuery(this).trigger("render")))})},W=Object.freeze({PodsDFVFieldModel:i,RelationshipModel:A,RelationshipCollection:M,FileUploadModel:o,FileUploadCollection:d}),X={fields:J,models:W,fieldInstances:{}};return jQuery.fn.PodsDFVInit=G,jQuery(function(){jQuery(".pods-form-ui-field").PodsDFVInit(X.fieldInstances)}),X}();